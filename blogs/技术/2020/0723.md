---
title: vue-router路由模式详解
date: 2020-07-23
tags:
  - Vue
categories:
  - 技术
---

## 路由模式解析

要讲 vue-router 的路由模式，首先要了解的一点就是路由是由多个 URL 组成的，使用不同的 URL 可以相应的导航到不同的位置。

如果有进行过服务器开发或者对 http 协议有所了解就会知道，浏览器中对页面的访问是无状态的，所以我们在切换不同的页面时都会重新进行请求。而实际使用 vue 和 vue-router 开发就会明白，在切换页面时是没有重新进行请求的，使用起来就好像页面是有状态的，这是什么原因呢。

这其实是借助了浏览器的 History API 来实现的，这样可以使得页面跳转而不刷新，页面的状态就被维持在浏览器中了。

vue-router 中默认使用的是 hash 模式，URL 中带有#号，也就是会出现如下的 URL：

![Vue](https://vkceyugu.cdn.bspapp.com/VKCEYUGU-aliyun-umybkfmeehmg0383ca/8ba9f210-4856-11eb-b680-7980c8a877b8.png)

我们可以用如下代码修改成 history 模式：

```js
import Vue from 'vue'
import Router from 'vue-router'
import Main from '@/components/Main'
Vue.use(Router)

export default new Router({
	mode: 'history',
	routes: [
		{
			path: '/',
			component: Main
		}
	]
})
```

这样子 URL 中的#号就被去除了。

实际上存在三种模式：

Hash: 使用 URL 的 hash 值来作为路由。支持所有浏览器。

History: 以来 HTML5 History API 和服务器配置。参考官网中 HTML5 History 模式

Abstract： 支持所有 javascript 运行模式。如果发现没有浏览器的 API，路由会自动强制进入这个模式。

## 两种模式的区别

### hash 模式

hash 模式背后的原理是 onhashchange 事件，可以在 window 对象上监听这个事件：

```js
window.onhashchange = function(event) {
	console.log(event.oldURL, event.newURL)
	let hash = location.hash.slice(1)
	document.body.style.color = hash
}
```

上面的代码可以通过改变 hash 来改变页面字体颜色，虽然没什么用，但是一定程度上说明了原理。

更关键的一点是，因为 hash 发生变化的 url 都会被浏览器记录下来，从而你会发现浏览器的前进后退都可以用了，同时点击后退时，页面字体颜色也会发生变化。这样一来，尽管浏览器没有请求服务器，但是页面状态和 url 一一关联起来，后来人们给它起了一个霸气的名字叫前端路由，成为了单页应用标配。

我们写个简单的方法来测试一下

```js
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    <div>测试一下</div>
    <script type="text/javascript">
        window.onhashchange = function(event){
            console.log(event.oldURL,event.newURL)
            let hash = location.hash.slice(1);
            document.body.style.color = hash;
        }
    </script>
</body>
</html>
```

![Vue](https://vkceyugu.cdn.bspapp.com/VKCEYUGU-aliyun-umybkfmeehmg0383ca/8c45e3f0-4856-11eb-b680-7980c8a877b8.png)
![Vue](https://vkceyugu.cdn.bspapp.com/VKCEYUGU-aliyun-umybkfmeehmg0383ca/8cec0f00-4856-11eb-b997-9918a5dda011.png)

并且通过浏览器的前进、后退页面均可以变化。

网易云音乐，百度网盘就采用了 hash 路由，看起来就是这个样子:

http://music.163.com/#/friend
https://pan.baidu.com/disk/home#list/vmode=list

### history 路由

随着 history api 的到来，前端路由开始进化了，前面的 hashchange，你只能改变#后面的 url 片段，而 history api 则给了前端完全的自由

history api 可以分为两大部分：切换和修改

#### 切换历史状态

包括 back、forward、go 三个方法，对应浏览器的前进，后退，跳转操作，有同学说了，(谷歌)浏览器只有前进和后退，没有跳转，嗯，在前进后退上长按鼠标，会出来所有当前窗口的历史记录，从而可以跳转(也许叫跳更合适)：

```js
history.go(-2) //后退两次
history.go(2) //前进两次
history.back() //后退
hsitory.forward() //前进
```

#### 修改历史状态

```js
history.pushState({ color: 'red' }, 'red', 'red')

window.onpopstate = function(event) {
	console.log(event.state)
	if (event.state && event.state.color === 'red') {
		document.body.style.color = 'red'
	}
}

history.back()

history.forward()
```

通过 pushstate 把页面的状态保存在 state 对象中，当页面的 url 再变回这个 url 时，可以通过 event.state 取到这个 state 对象，从而可以对页面状态进行还原，这里的页面状态就是页面字体颜色，其实滚动条的位置，阅读进度，组件的开关的这些页面状态都可以存储到 state 的里面。

通过 history api，我们丢掉了丑陋的#，但是它也有个毛病：

不怕前进，不怕后退，就怕刷新，f5，（如果后端没有准备的话），因为刷新是实实在在地去请求服务器的。

在 hash 模式下，前端路由修改的是#中的信息，而浏览器请求时是不带它玩的，所以没有问题。但是在 history 下，你可以自由的修改 path，当刷新时，如果服务器中没有相应的响应或者资源，会分分钟刷出一个 404 来。

#### popstate 实现 history 路由拦截，监听页面返回事件

当活动历史记录条目更改时，将触发 popstate 事件。

1、如果被激活的历史记录条目是通过对 history.pushState() 的调用创建的，或者受到对 history.replaceState() 的调用的影响，popstate 事件的 state 属性包含历史条目的状态对象的副本。

2、需要注意的是调用 history.pushState() 或 history.replaceState() 用来在浏览历史中添加或修改记录，不会触发 popstate 事件；

只有在做出浏览器动作时，才会触发该事件，如用户点击浏览器的回退按钮（或者在 Javascript 代码中调用 history.back()）

我们测试一下：

```js
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    <div>测试一下</div>
    <script type="text/javascript">
        if (window.history && window.history.pushState) {
           window.onpopstate = function(event) {
              console.log("location: " + document.location + ", state: " + JSON.stringify(event.state));
              //window.history.go(1)
              //window.history.back()
           };

           //window.addEventListener("popstate", function(e) {
           //   window.location = 'http://www.baidu.com';
           //}, false);

           !function() {
              var state = {
                 title: "title",
                 url: "#"
              };
              window.history.pushState(state, "title", "#");
           }();
        }
    </script>
</body>
</html>
```

刷新时不打印，刷新多次，再后退，每次都有，直到为 null

![Vue](https://vkceyugu.cdn.bspapp.com/VKCEYUGU-aliyun-umybkfmeehmg0383ca/8d903e40-4856-11eb-b680-7980c8a877b8.png)

::: tip
作者：古兰精 <br>
链接：https://www.cnblogs.com/goloving/p/9147551.html <br>
来源：博客园
:::
